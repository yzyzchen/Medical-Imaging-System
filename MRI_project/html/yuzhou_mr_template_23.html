
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>yuzhou_mr_template_23</title><meta name="generator" content="MATLAB 9.12"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2023-11-23"><meta name="DC.source" content="yuzhou_mr_template_23.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; }

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }
span.typesection { color:#A0522D }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h2>Contents</h2><div><ul><li><a href="#2">Select whether to load complex 2D object or create simple point object</a></li><li><a href="#3">Define simulation constants</a></li><li><a href="#4">part 1</a></li><li><a href="#5">part 2</a></li><li><a href="#6">part 3</a></li><li><a href="#7">part 4</a></li><li><a href="#8">part 5</a></li><li><a href="#9">part 6</a></li><li><a href="#10">part 7</a></li><li><a href="#11">part 8</a></li><li><a href="#12">part 9</a></li><li><a href="#13">part 10 11</a></li></ul></div><pre class="codeinput"><span class="comment">% BME/EECS516</span>
<span class="comment">% MRI Project Template</span>
clc
clear <span class="string">all</span>
<span class="comment">% Other m-files required: ift2, ift, ft2, ft, blochsim_516</span>
<span class="comment">% Subfunctions: none</span>
<span class="comment">% MAT-files required: object18.mat</span>

<span class="comment">%Programme: YUZHOU CHEN</span>
<span class="comment">%DATA:November 23, 2023</span>
<span class="comment">%Oct 2022;</span>
<span class="comment">%Last revision: Oct-30-2022</span>
</pre><h2 id="2">Select whether to load complex 2D object or create simple point object</h2><pre class="codeinput">complexobj = 0;
<span class="keyword">if</span> complexobj
   <span class="comment">% 2D Object for reconstruction</span>
  load <span class="string">object23</span>;
<span class="keyword">else</span>
  <span class="comment">% Single point object at (x,y,z) = (2,2,0) cm;</span>
  <span class="comment">% Point object has T1 of 1000 ms, T2 of 100 ms</span>
  obj_x = 4;
  obj_y = 4;
  obj_z = 0;
  obj_T1 = 1000;
  obj_T2 = 100;
<span class="keyword">end</span>

FOVx = 16;
FOVy = 12;
Nx = 80;
Ny = 60;
T_read = 8;
T_y = 2;
obj_n = length(obj_x); <span class="comment">% Determine number of objects</span>
</pre><h2 id="3">Define simulation constants</h2><p>Physical constants</p><pre class="codeinput">gambar = 42570;               <span class="comment">% Gamma/2pi in kHz/T</span>
gam = gambar*2*pi;            <span class="comment">% Gamma in kiloradians/T</span>

<span class="comment">% Simulation values</span>
dt = 0.05;                    <span class="comment">% Time step for simulation, ms (50 us step size)</span>
te = 10.0;                    <span class="comment">% Echo time, ms</span>
endtime = 16;                 <span class="comment">% Total runtime of simulation, ms</span>
time = [0:dt:endtime]';       <span class="comment">% Vector containing each time step, ms (size #timepoints x 1)</span>
totalTimepoints = length(time);          <span class="comment">% Number of time points for simulation</span>

<span class="comment">% Initialize B vectors, the effective (x,y,z) applied magnetic field</span>
<span class="comment">% Vectors define applied magnetic field at time tp_n for object obj_n</span>

bx = zeros([totalTimepoints obj_n]);
by = zeros([totalTimepoints obj_n]);
bz = zeros([totalTimepoints obj_n]);

<span class="comment">% Define a 90 RF pulse</span>
rf90pw = 3;                  <span class="comment">% Pulse width in ms</span>
sincper = rf90pw/4;          <span class="comment">% in ms (this is the sinc stretch parameter)</span>
                             <span class="comment">% e.g. sinc(time/sincper) as shown below</span>
rf_timepoints = rf90pw/dt;   <span class="comment">% Number of simulation steps for RF</span>
rf_time = [-(rf_timepoints-1) / 2 : (rf_timepoints-1) / 2]'.*dt; <span class="comment">% Time vector for creating sinc, centered at 0</span>
rf_shape = hanning(rf_timepoints) .* sinc(rf_time./sincper); <span class="comment">% Sinc waveform shape with hanning window, with amplitude 1</span>
rf_amplitude90 = (pi / 2)/(gam * dt * sum(rf_shape));        <span class="comment">% REPLACE 0 with amplitude of the RF pulse here, in T</span>
<span class="comment">% Scale rf_shape by a_rf90 (amplitude), then fill the remainder of the time with zeros</span>
b1_90 = rf_amplitude90.*[rf_shape; zeros([totalTimepoints-rf_timepoints 1])];
m0 = [0; 0; 1];
gz = 0;
omega_shift = gam * gz * 0;
</pre><h2 id="4">part 1</h2><pre class="codeinput">bx = b1_90;
[mx,my,mz] = blochsim_516(m0,bx,by,bz,obj_T1,obj_T2,dt);
figure (1)
subplot(3,1,1)
plot(time,mx);xlabel(<span class="string">'time (ms)'</span>);ylabel(<span class="string">'Mx'</span>);axis([0 endtime -1 1]);title(<span class="string">'part1'</span>);
subplot(3,1,2)
plot(time,my);xlabel(<span class="string">'time (ms)'</span>);ylabel(<span class="string">'My'</span>);axis([0 endtime -1 1]);
subplot(3,1,3)
plot(time,mz);xlabel(<span class="string">'time (ms)'</span>);ylabel(<span class="string">'Mz'</span>);axis([0 endtime -1 1]);
</pre><img vspace="5" hspace="5" src="yuzhou_mr_template_23_01.png" alt=""> <h2 id="5">part 2</h2><pre class="codeinput">obj_T1_1 = 20;
obj_T2_2 = 10;
[mx_2,my_2,mz_2] = blochsim_516(m0,bx,by,bz,obj_T1_1,obj_T2_2,dt);

figure (2)
subplot(3,2,1)
plot(time,mx);xlabel(<span class="string">'time (ms)'</span>);ylabel(<span class="string">'Mx'</span>);axis([0 endtime -1 1]);title(<span class="string">'part 1: (T1, T2) = (1000, 100)'</span>);
subplot(3,2,3)
plot(time,my);xlabel(<span class="string">'time (ms)'</span>);ylabel(<span class="string">'My'</span>);axis([0 endtime -1 1]);
subplot(3,2,5)
plot(time,mz);xlabel(<span class="string">'time (ms)'</span>);ylabel(<span class="string">'Mz'</span>);axis([0 endtime -1 1]);
subplot(3,2,2)
plot(time,mx_2);xlabel(<span class="string">'time (ms)'</span>);ylabel(<span class="string">'Mx'</span>);axis([0 endtime -1 1]);title(<span class="string">'part 2: (T1, T2) = (20, 10)'</span>);
subplot(3,2,4)
plot(time,my_2);xlabel(<span class="string">'time (ms)'</span>);ylabel(<span class="string">'My'</span>);axis([0 endtime -1 1]);
subplot(3,2,6)
plot(time,mz_2);xlabel(<span class="string">'time (ms)'</span>);ylabel(<span class="string">'Mz'</span>);axis([0 endtime -1 1]);
</pre><img vspace="5" hspace="5" src="yuzhou_mr_template_23_02.png" alt=""> <h2 id="6">part 3</h2><p>Create gradients Create gz</p><pre class="codeinput">rf90bw = 1 / sincper;    <span class="comment">%bandwith of RF</span>
slThick = 1;             <span class="comment">% Slick thickness in cm</span>
gz1_a = 2*pi*rf90bw/gam/slThick;                <span class="comment">% REPLACE 0 with amplitude of gz1 in T/cm</span>
gz1_pw = rf90pw;           <span class="comment">% Match the width of gz1 to the RF pulse</span>
gz2_a = -gz1_a;             <span class="comment">% REPLACE 0 with amplitude of gz2 in T/cm</span>
gz2_pw = rf90pw/2;
<span class="comment">% Create gz with positve area gz1_a*gz1_pw, followed by negative area gz2_a*gz2pw</span>
<span class="comment">% gz step size is dt, with amplitude values in T/cm</span>
gz =  (time &lt; gz1_pw) .* gz1_a <span class="keyword">...</span>
       + (time &gt;= gz1_pw).*(time &lt; (gz1_pw+gz2_pw)) .* gz2_a;
bz_3 = gz * obj_z;
[mx_3,my_3,mz_3] = blochsim_516(m0,bx,by,bz_3,obj_T1,obj_T2,dt);

figure (3)
subplot(3,2,1)
plot(time,mx);xlabel(<span class="string">'time (ms)'</span>);ylabel(<span class="string">'Mx'</span>);axis([0 endtime -1 1]);title(<span class="string">'part 1: without Gz'</span>);
subplot(3,2,3)
plot(time,my);xlabel(<span class="string">'time (ms)'</span>);ylabel(<span class="string">'My'</span>);axis([0 endtime -1 1]);
subplot(3,2,5)
plot(time,mz);xlabel(<span class="string">'time (ms)'</span>);ylabel(<span class="string">'Mz'</span>);axis([0 endtime -1 1]);
subplot(3,2,2)
plot(time,mx_3);xlabel(<span class="string">'time (ms)'</span>);ylabel(<span class="string">'Mx'</span>);axis([0 endtime -1 1]);title(<span class="string">'part 3: with Gz'</span>);
subplot(3,2,4)
plot(time,my_3);xlabel(<span class="string">'time (ms)'</span>);ylabel(<span class="string">'My'</span>);axis([0 endtime -1 1]);
subplot(3,2,6)
plot(time,mz_3);xlabel(<span class="string">'time (ms)'</span>);ylabel(<span class="string">'Mz'</span>);axis([0 endtime -1 1]);
</pre><img vspace="5" hspace="5" src="yuzhou_mr_template_23_03.png" alt=""> <h2 id="7">part 4</h2><pre class="codeinput">obj_z_41 = 0.2;
obj_z_42 = 1;
bz_41 = gz * obj_z_41;
bz_42 = gz * obj_z_42;

[mx_41,my_41,mz_41] = blochsim_516(m0,bx,by,bz_41,obj_T1,obj_T2,dt);
[mx_42,my_42,mz_42] = blochsim_516(m0,bx,by,bz_42,obj_T1,obj_T2,dt);
figure (4)
subplot(3,3,1)
plot(time,mx_3);xlabel(<span class="string">'time (ms)'</span>);ylabel(<span class="string">'Mx'</span>);axis([0 endtime -1 1]);title(<span class="string">'part 3: z = 0'</span>);subtitle(<span class="string">'with Gz'</span>);
subplot(3,3,4)
plot(time,my_3);xlabel(<span class="string">'time (ms)'</span>);ylabel(<span class="string">'My'</span>);axis([0 endtime -1 1]);
subplot(3,3,7)
plot(time,mz_3);xlabel(<span class="string">'time (ms)'</span>);ylabel(<span class="string">'Mz'</span>);axis([0 endtime -1 1]);
subplot(3,3,2)
plot(time,mx_41);xlabel(<span class="string">'time (ms)'</span>);ylabel(<span class="string">'Mx'</span>);axis([0 endtime -1 1]);title(<span class="string">'part 4: z = 0.2'</span>);subtitle(<span class="string">'with Gz'</span>);
subplot(3,3,5)
plot(time,my_41);xlabel(<span class="string">'time (ms)'</span>);ylabel(<span class="string">'My'</span>);axis([0 endtime -1 1]);
subplot(3,3,8)
plot(time,mz_41);xlabel(<span class="string">'time (ms)'</span>);ylabel(<span class="string">'Mz'</span>);axis([0 endtime -1 1]);
subplot(3,3,3)
plot(time,mx_42);xlabel(<span class="string">'time (ms)'</span>);ylabel(<span class="string">'Mx'</span>);axis([0 endtime -1 1]);title(<span class="string">'part 4: z = 1'</span>);subtitle(<span class="string">'with Gz'</span>);
subplot(3,3,6)
plot(time,my_42);xlabel(<span class="string">'time (ms)'</span>);ylabel(<span class="string">'My'</span>);axis([0 endtime -1 1]);
subplot(3,3,9)
plot(time,mz_42);xlabel(<span class="string">'time (ms)'</span>);ylabel(<span class="string">'Mz'</span>);axis([0 endtime -1 1]);
</pre><img vspace="5" hspace="5" src="yuzhou_mr_template_23_04.png" alt=""> <h2 id="8">part 5</h2><p>Create gx</p><pre class="codeinput">k_x = 1/FOVx;
gx_5b = Nx* k_x / T_read / gambar;
gx_5a = -2 * gx_5b;

t_gx_1 = 5.5;
t_gx_2 = 7.5;
t_gx_3 = 15.5;

gx_5 =  (time &gt;= t_gx_1).*(time &lt; t_gx_2) .* gx_5a <span class="keyword">...</span>
       + (time &gt;= t_gx_2).*(time &lt; t_gx_3) .* gx_5b;

bx_5 = b1_90;
by_5 = zeros([totalTimepoints obj_n]);
bz_5 = gx_5 * obj_x;

[mx_5,my_5,mz_5] = blochsim_516(m0,bx_5,by_5,bz_5,obj_T1,obj_T2,dt);
figure (5)
subplot(3,2,1)
plot(time,mx_3);xlabel(<span class="string">'time (ms)'</span>);ylabel(<span class="string">'Mx'</span>);axis([0 endtime -1 1]);title(<span class="string">'part 3: without Gx'</span>);
subplot(3,2,3)
plot(time,my_3);xlabel(<span class="string">'time (ms)'</span>);ylabel(<span class="string">'My'</span>);axis([0 endtime -1 1]);
subplot(3,2,5)
plot(time,mz_3);xlabel(<span class="string">'time (ms)'</span>);ylabel(<span class="string">'Mz'</span>);axis([0 endtime -1 1]);
subplot(3,2,2)
plot(time,mx_5);xlabel(<span class="string">'time (ms)'</span>);ylabel(<span class="string">'Mx'</span>);axis([0 endtime -1 1]);title(<span class="string">'part 5: with Gx'</span>);
subplot(3,2,4)
plot(time,my_5);xlabel(<span class="string">'time (ms)'</span>);ylabel(<span class="string">'My'</span>);axis([0 endtime -1 1]);
subplot(3,2,6)
plot(time,mz_5);xlabel(<span class="string">'time (ms)'</span>);ylabel(<span class="string">'Mz'</span>);axis([0 endtime -1 1]);
</pre><img vspace="5" hspace="5" src="yuzhou_mr_template_23_05.png" alt=""> <h2 id="9">part 6</h2><pre class="codeinput">nread = 80;
npe = 60;
by_6 = zeros([totalTimepoints obj_n]);
sig_6 = zeros([nread 1]);
gy_6 = zeros([totalTimepoints 1]);
bz_6 = gx_5 * obj_x;
[mx_6,my_6,mz_6] = blochsim_516(m0,bx_5,by_6,bz_6,obj_T1,obj_T2,dt);
M_6 = mx_6 + 1i * my_6;
index_1 = 1;
<span class="keyword">for</span> index = 1 : totalTimepoints
    <span class="keyword">if</span> (index &gt;= 151 &amp;&amp; index &lt;= 310) &amp;&amp; mod(index,2) == 1
    sig_6(index_1,1) = M_6(index,1);
    index_1 = index_1 + 1;
    <span class="keyword">end</span>
<span class="keyword">end</span>
xpos = [-nread/2:nread/2-1]/nread.*FOVx;
ypos = [-npe/2:npe/2-1]/npe*FOVy;
figure(6)
plot(xpos,abs(ift(sig_6)));xlabel(<span class="string">'x (cm)'</span>);ylabel(<span class="string">'received signal'</span>);axis([-8 8 -1 1]);title(<span class="string">'magnitude vs spatial position'</span>);
</pre><img vspace="5" hspace="5" src="yuzhou_mr_template_23_06.png" alt=""> <h2 id="10">part 7</h2><p>Create gy</p><pre class="codeinput">k_y = 1/FOVy;
gy_max = Ny * k_y / gambar / T_y / 2;
delta_gy = 2 * pi / (gam * 2 *FOVy);
by_7 = zeros([totalTimepoints obj_n]);
sig_7 = zeros([nread npe]);
M_7 = zeros([totalTimepoints npe]);
<span class="keyword">for</span> pe = 1:npe
    gy_7 = (time &gt;= t_gx_1).*(time &lt; t_gx_2) .* (delta_gy * (pe - 1) - gy_max);
    bz_7 = gx_5 * obj_x + gy_7 * obj_y + gz * obj_z;
    [mx_7,my_7,mz_7] = blochsim_516(m0,bx_5,by_7,bz_7,obj_T1,obj_T2,dt);
    M_7(:,pe)= mx_7 + 1i * my_7;
    index_1 = 1;
    <span class="keyword">for</span> index = 1 : totalTimepoints
        <span class="keyword">if</span> (index &gt;= 151 &amp;&amp; index &lt;= 310) &amp;&amp; mod(index,2) == 1
        sig_7(index_1,pe) = M_7(index,pe);
        index_1 = index_1 + 1;
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>

<span class="comment">% show images for parts 7-10</span>
W_kx = k_x * Nx;
W_ky = k_y * Ny;
kxpos = linspace(-W_kx/2, W_kx/2, Nx);  <span class="comment">% vector of kx locations</span>
kypos = linspace(-W_ky/2, W_ky/2, Ny);  <span class="comment">% vector of ky locations</span>

figure(7)
subplot(2,1,1)
imagesc(kxpos,kypos,real(sig_7)'); colormap <span class="string">gray</span>; axis(<span class="string">'image'</span>); axis(<span class="string">'xy'</span>)
xlabel(<span class="string">'kx cm^{-1}'</span>);
ylabel(<span class="string">'ky cm^{-1}'</span>);
title(<span class="string">'REAL M(kx,ky)'</span>)

<span class="comment">% disp 'Press any key to continue...'; pause</span>

subplot(2,1,2)
imagesc(kxpos,kypos,imag(sig_7)'); colormap <span class="string">gray</span>; axis(<span class="string">'image'</span>); axis(<span class="string">'xy'</span>)
xlabel(<span class="string">'kx (cm^{-1})'</span>);
ylabel(<span class="string">'ky (cm^{-1})'</span>);
title(<span class="string">'IMAG M(kx,ky)'</span>)
<span class="comment">%disp 'Press any key to continue...'; pause</span>
</pre><img vspace="5" hspace="5" src="yuzhou_mr_template_23_07.png" alt=""> <h2 id="11">part 8</h2><pre class="codeinput">figure(8)
imagesc(xpos,ypos,abs(ift2(sig_7))'); colormap <span class="string">gray</span>; axis(<span class="string">'image'</span>); axis(<span class="string">'xy'</span>)
xlabel(<span class="string">'x (cm)'</span>);
ylabel(<span class="string">'y (cm)'</span>);
title(<span class="string">'abs(image(x,y))'</span>)

<span class="comment">%disp 'Press any key to continue...'; pause</span>
</pre><img vspace="5" hspace="5" src="yuzhou_mr_template_23_08.png" alt=""> <h2 id="12">part 9</h2><pre class="codeinput">by_9 = zeros([totalTimepoints obj_n]);
sig_9 = zeros([nread npe]);
index_1 = 1;
M_9 = zeros([totalTimepoints npe]);
<span class="keyword">for</span> pe = 1:npe
    gy_9 = (time &gt;= t_gx_1).*(time &lt; t_gx_2) .* (delta_gy * (pe - 1) - gy_max);
    bz_9 = gx_5 * obj_x + gy_9 * 10 + gz * obj_z;
    [mx_9,my_9,mz_9] = blochsim_516(m0,bx_5,by_7,bz_9,obj_T1,obj_T2,dt);
    M_9(:,pe)= mx_9 + 1i * my_9;
    index_1 = 1;
    <span class="keyword">for</span> index = 1 : totalTimepoints
        <span class="keyword">if</span> (index &gt;= 151 &amp;&amp; index &lt;= 310) &amp;&amp; mod(index,2) == 1
        sig_9(index_1,pe) = M_9(index,pe);
        index_1 = index_1 + 1;
        <span class="keyword">end</span>
    <span class="keyword">end</span>
<span class="keyword">end</span>

figure(9)
imagesc(xpos,ypos,abs(ift2(sig_9))'); colormap <span class="string">gray</span>; axis(<span class="string">'image'</span>); axis(<span class="string">'xy'</span>)
xlabel(<span class="string">'x (cm)'</span>);
ylabel(<span class="string">'y (cm)'</span>);
title(<span class="string">'abs(image(x,y))'</span>)

<span class="comment">%disp 'Press any key to continue...'; pause</span>
</pre><img vspace="5" hspace="5" src="yuzhou_mr_template_23_09.png" alt=""> <h2 id="13">part 10 11</h2><pre class="codeinput">load <span class="string">object23.mat</span>
b1_90_x = zeros([totalTimepoints 1]);
b1_90_y = zeros([totalTimepoints 1]);
obj_n = 2850;
m0_10 = [zeros([2 obj_n]);
         ones([1 obj_n])];
M_10 = zeros([totalTimepoints npe]);
sig_10 = zeros([nread npe]);
<span class="keyword">for</span> slice = 1:2  <span class="comment">% slice loop</span>
    <span class="keyword">if</span> slice == 1
        z_slice = 0;
    <span class="keyword">else</span>
        z_slice = 1;
    <span class="keyword">end</span>

    omega_shift = gam * gz1_a * z_slice;
    <span class="keyword">for</span> tt = 1 : totalTimepoints
        b1_90_x(tt,:) = b1_90(tt,:) * cos(omega_shift * tt * dt);
        b1_90_y(tt,:) = b1_90(tt,:) * sin(omega_shift * tt * dt);
    <span class="keyword">end</span>
        bx_10 = b1_90_x * ones([1 obj_n]);
        by_10 = b1_90_y * ones([1 obj_n]);
        gx_10 = gx_5;
        gz_10 = gz;
        <span class="comment">%figure (10)</span>
    <span class="keyword">for</span> pe = 1:npe
        gy_10 = (time &gt;= t_gx_1).*(time &lt; t_gx_2) .* (delta_gy * (pe - 1) - gy_max);
        bz_10 = gx_10 * obj_x + gy_10 * obj_y + gz * obj_z;
        [mx_10,my_10,mz_10] = blochsim_516(m0_10,bx_10,by_10,bz_10,obj_T1,obj_T2,dt);
<span class="comment">%         subplot(3,1,1)</span>
<span class="comment">%         plot(time,sum(mx_10,2)/obj_n);xlabel('time (ms)');ylabel('Mx');axis([0 endtime -1 1]);title('part 10');</span>
<span class="comment">%         subplot(3,1,2)</span>
<span class="comment">%         plot(time,sum(my_10,2)/obj_n);xlabel('time (ms)');ylabel('My');axis([0 endtime -1 1]);</span>
<span class="comment">%         subplot(3,1,3)</span>
<span class="comment">%         plot(time,sum(mz_10,2)/obj_n);xlabel('time (ms)');ylabel('Mz');axis([0 endtime -1 1]);</span>
<span class="comment">%         pause(0.01);</span>
        M_10(:,pe) = sum(mx_10,2)+ 1i.*sum(my_10,2);
        index_1 = 1;
        <span class="keyword">for</span> index = 1 : totalTimepoints
            <span class="keyword">if</span> (index &gt;= 151 &amp;&amp; index &lt;= 310) &amp;&amp; mod(index,2) == 1
                sig_10(index_1,pe) = M_10(index,pe);
                index_1 = index_1 + 1;
            <span class="keyword">end</span>
        <span class="keyword">end</span>
    <span class="keyword">end</span>

    <span class="comment">%close(figure(10))</span>

    <span class="keyword">if</span> slice == 1
        figure(11)
    <span class="keyword">else</span>
        figure(12)
    <span class="keyword">end</span>

    subplot(2,2,1)
    imagesc(kxpos,kypos,real(sig_10)'); colormap <span class="string">gray</span>; axis(<span class="string">'image'</span>); axis(<span class="string">'xy'</span>)
    xlabel(<span class="string">'kx (cm^{-1})'</span>);
    ylabel(<span class="string">'ky (cm^{-1})'</span>);
    title(<span class="string">'real(M(kx,ky))'</span>)


    subplot(2,2,2)
    imagesc(kxpos,kypos,imag(sig_10)'); colormap <span class="string">gray</span>; axis(<span class="string">'image'</span>); axis(<span class="string">'xy'</span>)
    xlabel(<span class="string">'kx (cm^{-1})'</span>);
    ylabel(<span class="string">'ky (cm^{-1})'</span>);
    title(<span class="string">'imag(M(kx,ky))'</span>)

        subplot(2,2,3)
    imagesc(kxpos,kypos,abs(sig_10)'); colormap <span class="string">gray</span>; axis(<span class="string">'image'</span>); axis(<span class="string">'xy'</span>)
    xlabel(<span class="string">'kx (cm^{-1})'</span>);
    ylabel(<span class="string">'ky (cm^{-1})'</span>);
    title(<span class="string">'abs(M(kx,ky))'</span>)

    subplot(2,2,4)
    imagesc(xpos,ypos,abs(ift2(sig_10))'); colormap <span class="string">gray</span>; axis(<span class="string">'image'</span>); axis(<span class="string">'xy'</span>)
    xlabel(<span class="string">'x (cm)'</span>);
    ylabel(<span class="string">'y (cm)'</span>);
    title(<span class="string">'abs(image(x,y))'</span>)
<span class="keyword">end</span>
</pre><img vspace="5" hspace="5" src="yuzhou_mr_template_23_10.png" alt=""> <img vspace="5" hspace="5" src="yuzhou_mr_template_23_11.png" alt=""> <p class="footer"><br><a href="https://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2022a</a><br></p></div><!--
##### SOURCE BEGIN #####
% BME/EECS516
% MRI Project Template
clc 
clear all
% Other m-files required: ift2, ift, ft2, ft, blochsim_516
% Subfunctions: none
% MAT-files required: object18.mat

%Programme: YUZHOU CHEN
%DATA:November 23, 2023
%Oct 2022;
%Last revision: Oct-30-2022

%% Select whether to load complex 2D object or create simple point object
complexobj = 0;
if complexobj
   % 2D Object for reconstruction
  load object23;
else
  % Single point object at (x,y,z) = (2,2,0) cm;
  % Point object has T1 of 1000 ms, T2 of 100 ms
  obj_x = 4;
  obj_y = 4;
  obj_z = 0;
  obj_T1 = 1000;
  obj_T2 = 100;
end

FOVx = 16;
FOVy = 12;
Nx = 80;
Ny = 60;
T_read = 8;
T_y = 2;
obj_n = length(obj_x); % Determine number of objects

%% Define simulation constants
% Physical constants
gambar = 42570;               % Gamma/2pi in kHz/T
gam = gambar*2*pi;            % Gamma in kiloradians/T

% Simulation values
dt = 0.05;                    % Time step for simulation, ms (50 us step size)
te = 10.0;                    % Echo time, ms
endtime = 16;                 % Total runtime of simulation, ms
time = [0:dt:endtime]';       % Vector containing each time step, ms (size #timepoints x 1)
totalTimepoints = length(time);          % Number of time points for simulation

% Initialize B vectors, the effective (x,y,z) applied magnetic field
% Vectors define applied magnetic field at time tp_n for object obj_n

bx = zeros([totalTimepoints obj_n]);
by = zeros([totalTimepoints obj_n]);
bz = zeros([totalTimepoints obj_n]);

% Define a 90 RF pulse
rf90pw = 3;                  % Pulse width in ms
sincper = rf90pw/4;          % in ms (this is the sinc stretch parameter)
                             % e.g. sinc(time/sincper) as shown below
rf_timepoints = rf90pw/dt;   % Number of simulation steps for RF
rf_time = [-(rf_timepoints-1) / 2 : (rf_timepoints-1) / 2]'.*dt; % Time vector for creating sinc, centered at 0
rf_shape = hanning(rf_timepoints) .* sinc(rf_time./sincper); % Sinc waveform shape with hanning window, with amplitude 1
rf_amplitude90 = (pi / 2)/(gam * dt * sum(rf_shape));        % REPLACE 0 with amplitude of the RF pulse here, in T
% Scale rf_shape by a_rf90 (amplitude), then fill the remainder of the time with zeros
b1_90 = rf_amplitude90.*[rf_shape; zeros([totalTimepoints-rf_timepoints 1])];
m0 = [0; 0; 1];
gz = 0;
omega_shift = gam * gz * 0;

%% part 1
bx = b1_90;
[mx,my,mz] = blochsim_516(m0,bx,by,bz,obj_T1,obj_T2,dt);
figure (1)
subplot(3,1,1)
plot(time,mx);xlabel('time (ms)');ylabel('Mx');axis([0 endtime -1 1]);title('part1');
subplot(3,1,2)
plot(time,my);xlabel('time (ms)');ylabel('My');axis([0 endtime -1 1]);
subplot(3,1,3)
plot(time,mz);xlabel('time (ms)');ylabel('Mz');axis([0 endtime -1 1]);

%% part 2
obj_T1_1 = 20;
obj_T2_2 = 10;
[mx_2,my_2,mz_2] = blochsim_516(m0,bx,by,bz,obj_T1_1,obj_T2_2,dt);

figure (2)
subplot(3,2,1)
plot(time,mx);xlabel('time (ms)');ylabel('Mx');axis([0 endtime -1 1]);title('part 1: (T1, T2) = (1000, 100)');
subplot(3,2,3)
plot(time,my);xlabel('time (ms)');ylabel('My');axis([0 endtime -1 1]);
subplot(3,2,5)
plot(time,mz);xlabel('time (ms)');ylabel('Mz');axis([0 endtime -1 1]);
subplot(3,2,2)
plot(time,mx_2);xlabel('time (ms)');ylabel('Mx');axis([0 endtime -1 1]);title('part 2: (T1, T2) = (20, 10)');
subplot(3,2,4)
plot(time,my_2);xlabel('time (ms)');ylabel('My');axis([0 endtime -1 1]);
subplot(3,2,6)
plot(time,mz_2);xlabel('time (ms)');ylabel('Mz');axis([0 endtime -1 1]);

%% part 3
% Create gradients
% Create gz
rf90bw = 1 / sincper;    %bandwith of RF
slThick = 1;             % Slick thickness in cm
gz1_a = 2*pi*rf90bw/gam/slThick;                % REPLACE 0 with amplitude of gz1 in T/cm
gz1_pw = rf90pw;           % Match the width of gz1 to the RF pulse
gz2_a = -gz1_a;             % REPLACE 0 with amplitude of gz2 in T/cm
gz2_pw = rf90pw/2;
% Create gz with positve area gz1_a*gz1_pw, followed by negative area gz2_a*gz2pw
% gz step size is dt, with amplitude values in T/cm
gz =  (time < gz1_pw) .* gz1_a ...
       + (time >= gz1_pw).*(time < (gz1_pw+gz2_pw)) .* gz2_a;
bz_3 = gz * obj_z;
[mx_3,my_3,mz_3] = blochsim_516(m0,bx,by,bz_3,obj_T1,obj_T2,dt);

figure (3)
subplot(3,2,1)
plot(time,mx);xlabel('time (ms)');ylabel('Mx');axis([0 endtime -1 1]);title('part 1: without Gz');
subplot(3,2,3)
plot(time,my);xlabel('time (ms)');ylabel('My');axis([0 endtime -1 1]);
subplot(3,2,5)
plot(time,mz);xlabel('time (ms)');ylabel('Mz');axis([0 endtime -1 1]);
subplot(3,2,2)
plot(time,mx_3);xlabel('time (ms)');ylabel('Mx');axis([0 endtime -1 1]);title('part 3: with Gz');
subplot(3,2,4)
plot(time,my_3);xlabel('time (ms)');ylabel('My');axis([0 endtime -1 1]);
subplot(3,2,6)
plot(time,mz_3);xlabel('time (ms)');ylabel('Mz');axis([0 endtime -1 1]);

%% part 4
obj_z_41 = 0.2;
obj_z_42 = 1;
bz_41 = gz * obj_z_41;
bz_42 = gz * obj_z_42;

[mx_41,my_41,mz_41] = blochsim_516(m0,bx,by,bz_41,obj_T1,obj_T2,dt);
[mx_42,my_42,mz_42] = blochsim_516(m0,bx,by,bz_42,obj_T1,obj_T2,dt);
figure (4)
subplot(3,3,1)
plot(time,mx_3);xlabel('time (ms)');ylabel('Mx');axis([0 endtime -1 1]);title('part 3: z = 0');subtitle('with Gz');
subplot(3,3,4)
plot(time,my_3);xlabel('time (ms)');ylabel('My');axis([0 endtime -1 1]);
subplot(3,3,7)
plot(time,mz_3);xlabel('time (ms)');ylabel('Mz');axis([0 endtime -1 1]);
subplot(3,3,2)
plot(time,mx_41);xlabel('time (ms)');ylabel('Mx');axis([0 endtime -1 1]);title('part 4: z = 0.2');subtitle('with Gz');
subplot(3,3,5)
plot(time,my_41);xlabel('time (ms)');ylabel('My');axis([0 endtime -1 1]);
subplot(3,3,8)
plot(time,mz_41);xlabel('time (ms)');ylabel('Mz');axis([0 endtime -1 1]);
subplot(3,3,3)
plot(time,mx_42);xlabel('time (ms)');ylabel('Mx');axis([0 endtime -1 1]);title('part 4: z = 1');subtitle('with Gz');
subplot(3,3,6)
plot(time,my_42);xlabel('time (ms)');ylabel('My');axis([0 endtime -1 1]);
subplot(3,3,9)
plot(time,mz_42);xlabel('time (ms)');ylabel('Mz');axis([0 endtime -1 1]);

%% part 5
% Create gx
k_x = 1/FOVx;
gx_5b = Nx* k_x / T_read / gambar;
gx_5a = -2 * gx_5b;

t_gx_1 = 5.5;
t_gx_2 = 7.5;
t_gx_3 = 15.5;

gx_5 =  (time >= t_gx_1).*(time < t_gx_2) .* gx_5a ...
       + (time >= t_gx_2).*(time < t_gx_3) .* gx_5b;

bx_5 = b1_90;
by_5 = zeros([totalTimepoints obj_n]);
bz_5 = gx_5 * obj_x;

[mx_5,my_5,mz_5] = blochsim_516(m0,bx_5,by_5,bz_5,obj_T1,obj_T2,dt);
figure (5)
subplot(3,2,1)
plot(time,mx_3);xlabel('time (ms)');ylabel('Mx');axis([0 endtime -1 1]);title('part 3: without Gx');
subplot(3,2,3)
plot(time,my_3);xlabel('time (ms)');ylabel('My');axis([0 endtime -1 1]);
subplot(3,2,5)
plot(time,mz_3);xlabel('time (ms)');ylabel('Mz');axis([0 endtime -1 1]);
subplot(3,2,2)
plot(time,mx_5);xlabel('time (ms)');ylabel('Mx');axis([0 endtime -1 1]);title('part 5: with Gx');
subplot(3,2,4)
plot(time,my_5);xlabel('time (ms)');ylabel('My');axis([0 endtime -1 1]);
subplot(3,2,6)
plot(time,mz_5);xlabel('time (ms)');ylabel('Mz');axis([0 endtime -1 1]);

%% part 6
nread = 80;
npe = 60;
by_6 = zeros([totalTimepoints obj_n]);
sig_6 = zeros([nread 1]);
gy_6 = zeros([totalTimepoints 1]);
bz_6 = gx_5 * obj_x;
[mx_6,my_6,mz_6] = blochsim_516(m0,bx_5,by_6,bz_6,obj_T1,obj_T2,dt);
M_6 = mx_6 + 1i * my_6;
index_1 = 1;
for index = 1 : totalTimepoints
    if (index >= 151 && index <= 310) && mod(index,2) == 1
    sig_6(index_1,1) = M_6(index,1);
    index_1 = index_1 + 1;
    end
end
xpos = [-nread/2:nread/2-1]/nread.*FOVx;
ypos = [-npe/2:npe/2-1]/npe*FOVy;
figure(6)
plot(xpos,abs(ift(sig_6)));xlabel('x (cm)');ylabel('received signal');axis([-8 8 -1 1]);title('magnitude vs spatial position');

%% part 7
% Create gy
k_y = 1/FOVy;
gy_max = Ny * k_y / gambar / T_y / 2;
delta_gy = 2 * pi / (gam * 2 *FOVy);
by_7 = zeros([totalTimepoints obj_n]);
sig_7 = zeros([nread npe]);
M_7 = zeros([totalTimepoints npe]);
for pe = 1:npe
    gy_7 = (time >= t_gx_1).*(time < t_gx_2) .* (delta_gy * (pe - 1) - gy_max);
    bz_7 = gx_5 * obj_x + gy_7 * obj_y + gz * obj_z;
    [mx_7,my_7,mz_7] = blochsim_516(m0,bx_5,by_7,bz_7,obj_T1,obj_T2,dt);
    M_7(:,pe)= mx_7 + 1i * my_7;
    index_1 = 1;
    for index = 1 : totalTimepoints
        if (index >= 151 && index <= 310) && mod(index,2) == 1
        sig_7(index_1,pe) = M_7(index,pe);
        index_1 = index_1 + 1;
        end
    end
end

% show images for parts 7-10
W_kx = k_x * Nx;
W_ky = k_y * Ny;
kxpos = linspace(-W_kx/2, W_kx/2, Nx);  % vector of kx locations
kypos = linspace(-W_ky/2, W_ky/2, Ny);  % vector of ky locations

figure(7)
subplot(2,1,1)
imagesc(kxpos,kypos,real(sig_7)'); colormap gray; axis('image'); axis('xy')
xlabel('kx cm^{-1}');
ylabel('ky cm^{-1}');
title('REAL M(kx,ky)')

% disp 'Press any key to continue...'; pause

subplot(2,1,2)
imagesc(kxpos,kypos,imag(sig_7)'); colormap gray; axis('image'); axis('xy')
xlabel('kx (cm^{-1})');
ylabel('ky (cm^{-1})');
title('IMAG M(kx,ky)')
%disp 'Press any key to continue...'; pause

%% part 8
figure(8)
imagesc(xpos,ypos,abs(ift2(sig_7))'); colormap gray; axis('image'); axis('xy')
xlabel('x (cm)');
ylabel('y (cm)');
title('abs(image(x,y))')

%disp 'Press any key to continue...'; pause
%% part 9
by_9 = zeros([totalTimepoints obj_n]);
sig_9 = zeros([nread npe]);
index_1 = 1;
M_9 = zeros([totalTimepoints npe]);
for pe = 1:npe
    gy_9 = (time >= t_gx_1).*(time < t_gx_2) .* (delta_gy * (pe - 1) - gy_max);
    bz_9 = gx_5 * obj_x + gy_9 * 10 + gz * obj_z;
    [mx_9,my_9,mz_9] = blochsim_516(m0,bx_5,by_7,bz_9,obj_T1,obj_T2,dt);
    M_9(:,pe)= mx_9 + 1i * my_9;
    index_1 = 1;
    for index = 1 : totalTimepoints
        if (index >= 151 && index <= 310) && mod(index,2) == 1
        sig_9(index_1,pe) = M_9(index,pe);
        index_1 = index_1 + 1;
        end
    end
end

figure(9)
imagesc(xpos,ypos,abs(ift2(sig_9))'); colormap gray; axis('image'); axis('xy')
xlabel('x (cm)');
ylabel('y (cm)');
title('abs(image(x,y))')

%disp 'Press any key to continue...'; pause

%% part 10 11
load object23.mat
b1_90_x = zeros([totalTimepoints 1]);
b1_90_y = zeros([totalTimepoints 1]);
obj_n = 2850;
m0_10 = [zeros([2 obj_n]);
         ones([1 obj_n])];
M_10 = zeros([totalTimepoints npe]);
sig_10 = zeros([nread npe]);
for slice = 1:2  % slice loop
    if slice == 1
        z_slice = 0;
    else
        z_slice = 1;
    end

    omega_shift = gam * gz1_a * z_slice;
    for tt = 1 : totalTimepoints
        b1_90_x(tt,:) = b1_90(tt,:) * cos(omega_shift * tt * dt);
        b1_90_y(tt,:) = b1_90(tt,:) * sin(omega_shift * tt * dt);
    end
        bx_10 = b1_90_x * ones([1 obj_n]);
        by_10 = b1_90_y * ones([1 obj_n]);
        gx_10 = gx_5;
        gz_10 = gz;
        %figure (10)
    for pe = 1:npe
        gy_10 = (time >= t_gx_1).*(time < t_gx_2) .* (delta_gy * (pe - 1) - gy_max);
        bz_10 = gx_10 * obj_x + gy_10 * obj_y + gz * obj_z;
        [mx_10,my_10,mz_10] = blochsim_516(m0_10,bx_10,by_10,bz_10,obj_T1,obj_T2,dt);
%         subplot(3,1,1)
%         plot(time,sum(mx_10,2)/obj_n);xlabel('time (ms)');ylabel('Mx');axis([0 endtime -1 1]);title('part 10');
%         subplot(3,1,2)
%         plot(time,sum(my_10,2)/obj_n);xlabel('time (ms)');ylabel('My');axis([0 endtime -1 1]);
%         subplot(3,1,3)
%         plot(time,sum(mz_10,2)/obj_n);xlabel('time (ms)');ylabel('Mz');axis([0 endtime -1 1]);
%         pause(0.01);
        M_10(:,pe) = sum(mx_10,2)+ 1i.*sum(my_10,2);
        index_1 = 1;
        for index = 1 : totalTimepoints
            if (index >= 151 && index <= 310) && mod(index,2) == 1
                sig_10(index_1,pe) = M_10(index,pe);
                index_1 = index_1 + 1;
            end
        end
    end

    %close(figure(10))

    if slice == 1
        figure(11)
    else
        figure(12)
    end

    subplot(2,2,1)
    imagesc(kxpos,kypos,real(sig_10)'); colormap gray; axis('image'); axis('xy')
    xlabel('kx (cm^{-1})');
    ylabel('ky (cm^{-1})');
    title('real(M(kx,ky))')


    subplot(2,2,2)
    imagesc(kxpos,kypos,imag(sig_10)'); colormap gray; axis('image'); axis('xy')
    xlabel('kx (cm^{-1})');
    ylabel('ky (cm^{-1})');
    title('imag(M(kx,ky))')

        subplot(2,2,3)
    imagesc(kxpos,kypos,abs(sig_10)'); colormap gray; axis('image'); axis('xy')
    xlabel('kx (cm^{-1})');
    ylabel('ky (cm^{-1})');
    title('abs(M(kx,ky))')
    
    subplot(2,2,4)
    imagesc(xpos,ypos,abs(ift2(sig_10))'); colormap gray; axis('image'); axis('xy')
    xlabel('x (cm)');
    ylabel('y (cm)');
    title('abs(image(x,y))')
end
##### SOURCE END #####
--></body></html>